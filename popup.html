<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://openrouter.ai https://en.wikipedia.org;">
    <title>Comfort Zone - Selection Research Suite</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f94706",
                        "wiki-blue": "#3366cc",
                        "reddit-orange": "#FF4500",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: { 
                        "display": ["Plus Jakarta Sans", "Inter", "sans-serif"],
                        "sans": ["Plus Jakarta Sans", "sans-serif"],
                        "serif": ["Noto Serif", "serif"]
                    },
                },
            },
        }
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; display: inline-block; vertical-align: middle; }
        .tool-tip { visibility: hidden; opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; transform: translateY(5px); pointer-events: none; }
        .group:hover .tool-tip { visibility: visible; opacity: 1; transform: translateY(0); }
        
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #334155; }
        
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display min-h-screen flex flex-col items-center p-4 select-text transition-colors duration-300">

    <!-- Header -->
    <div class="w-full bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-none mb-4 border border-slate-100 dark:border-slate-700 transition-all">
        <div class="flex items-center gap-3 mb-4">
            <div class="size-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg shadow-primary/30">
                <span class="material-symbols-outlined text-2xl">bolt</span>
            </div>
            <div>
                <h1 class="text-lg font-black text-slate-900 dark:text-white tracking-tight">Comfort Zone</h1>
                <p class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-widest">Selection Research Suite</p>
            </div>
        </div>
        
        <!-- Status -->
        <div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-100 dark:border-slate-800">
            <span class="material-symbols-outlined text-primary text-sm">info</span>
            <p class="text-slate-500 dark:text-slate-400 text-xs">Select any text to reveal the context-aware toolbar.</p>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="w-full bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-none mb-4 border border-slate-100 dark:border-slate-700 transition-all">
        <div class="flex items-center gap-2 mb-4">
            <span class="material-symbols-outlined text-slate-400">flashlight_on</span>
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Quick Actions</h2>
        </div>
        
        <div id="tool-container" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Settings -->
    <div class="w-full bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-none mb-4 border border-slate-100 dark:border-slate-700 transition-all">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-slate-400">settings</span>
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Configuration</h2>
            </div>
            <button onclick="toggleSettings()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                <span class="material-symbols-outlined text-slate-400 text-lg">open_in_new</span>
            </button>
        </div>
        
        <!-- API Key Input -->
        <div class="mb-4">
            <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">OpenRouter API Key</label>
            <input type="password" id="openrouter-key" placeholder="sk-or-v1-..." class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-xs focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none text-slate-900 dark:text-white transition-all">
        </div>
        
        <!-- Model Select -->
        <div class="mb-4">
            <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">Intelligence Model</label>
            <select id="model-select" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-xs outline-none text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 transition-all appearance-none cursor-pointer">
                <option value="xiaomi/mimo-v2-flash:free">MiMo V2 Flash (Optimized)</option>
                <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Pro</option>
                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
            </select>
        </div>
        
        <!-- Dark Mode Toggle -->
        <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-slate-400 text-sm">dark_mode</span>
                <p class="text-xs font-bold dark:text-white">Dark Interface</p>
            </div>
            <button onclick="toggleDarkMode()" id="dark-mode-toggle" class="w-10 h-5 bg-slate-200 dark:bg-primary rounded-full relative transition-all duration-300">
                <div class="absolute top-0.5 left-0.5 dark:left-5.5 w-4 h-4 bg-white rounded-full transition-all shadow-sm"></div>
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="w-full bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700 transition-all">
        <div class="flex items-center gap-2 mb-4">
            <span class="material-symbols-outlined text-slate-400">insights</span>
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Session Stats</h2>
        </div>
        
        <div class="grid grid-cols-3 gap-3">
            <div class="text-center p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl">
                <div class="text-xl font-black text-slate-900 dark:text-white" id="stat-selections">0</div>
                <div class="text-[10px] text-slate-500 font-bold uppercase tracking-tight">Selections</div>
            </div>
            <div class="text-center p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl">
                <div class="text-xl font-black text-slate-900 dark:text-white" id="stat-tools">4</div>
                <div class="text-[10px] text-slate-500 font-bold uppercase tracking-tight">Tools</div>
            </div>
            <div class="text-center p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl">
                <div class="text-xl font-black text-slate-900 dark:text-white" id="stat-status">OK</div>
                <div class="text-[10px] text-slate-500 font-bold uppercase tracking-tight">Status</div>
            </div>
        </div>
    </div>

    <script>
        const toolContainer = document.getElementById('tool-container');
        let state = {
            config: { openrouterKey: "", model: "xiaomi/mimo-v2-flash:free", isDark: false },
            tools: [
                { id: 'summarize', label: 'Summarize', icon: 'auto_awesome', active: true, group: 'ai', color: 'text-amber-400' },
                { id: 'explain', label: 'Deep Explain', icon: 'psychology', active: true, group: 'ai', color: 'text-indigo-400' },
                { id: 'wiki', label: 'Wikipedia', icon: 'menu_book', active: true, group: 'search', color: 'text-sky-400' },
                { id: 'copy', label: 'Smart Copy', icon: 'content_copy', active: true, group: 'util', color: 'text-emerald-400' }
            ],
            stats: { selections: 0 }
        };

        window.onload = async () => {
            // Load from storage
            const saved = await chrome.storage.local.get('mimo_research_v3');
            if (saved.mimo_research_v3) {
                state = JSON.parse(saved.mimo_research_v3);
                if (state.config.isDark) document.documentElement.classList.add('dark');
            }
            
            // Load stats
            const stats = await chrome.storage.local.get('selectionCount');
            state.stats.selections = stats.selectionCount || 0;
            updateStats();
            
            renderMenuBar();
            document.getElementById('openrouter-key').value = state.config.openrouterKey || "";
            document.getElementById('model-select').value = state.config.model || "xiaomi/mimo-v2-flash:free";
        };

        function renderMenuBar() {
            let html = '';
            let currentGroup = '';
            state.tools.filter(t => t.active).forEach(tool => {
                if (currentGroup && currentGroup !== tool.group) html += '<div class="w-px h-6 bg-white/10 mx-1"></div>';
                currentGroup = tool.group;
                html += `
                    <div class="relative group">
                        <button onclick="handleAction('${tool.id}')" class="p-3 rounded-xl hover:bg-white/10 transition-all active:scale-90 flex items-center justify-center bg-slate-100 dark:bg-slate-700">
                            <span class="material-symbols-outlined text-xl ${tool.color}">${tool.icon}</span>
                        </button>
                        <div class="tool-tip absolute -top-10 left-1/2 -translate-x-1/2 bg-slate-800/95 backdrop-blur-md text-white text-[10px] font-black px-2.5 py-1 rounded-lg whitespace-nowrap uppercase tracking-widest shadow-xl border border-white/10">
                            ${tool.label}
                        </div>
                    </div>`;
            });
            toolContainer.innerHTML = html;
        }

        function toggleDarkMode() {
            state.config.isDark = !state.config.isDark;
            document.documentElement.classList.toggle('dark');
            saveSettings();
        }

        function toggleSettings() {
            // Open options page in new tab
            chrome.runtime.openOptionsPage ? chrome.runtime.openOptionsPage() : window.open('options.html');
        }

        async function saveSettings() {
            state.config.openrouterKey = document.getElementById('openrouter-key').value;
            state.config.model = document.getElementById('model-select').value;
            await chrome.storage.local.set({ mimo_research_v3: JSON.stringify(state) });
        }

        async function handleAction(id) {
            state.stats.selections++;
            await chrome.storage.local.set({ selectionCount: state.stats.selections });
            updateStats();
            
            // Store selected text from content script
            const result = await chrome.storage.local.get('selectedText');
            const selectedText = result.selectedText || "No text selected";
            
            saveSettings();
            
            // For popup, we'll show a simple notification or open result in sidepanel
            if (id === 'copy') {
                await navigator.clipboard.writeText(selectedText);
                showNotification('Copied to clipboard!');
                return;
            }
            
            // Open sidepanel with result
            chrome.sidePanel.open ? chrome.sidePanel.open() : showNotification(`${id} action triggered`);
        }

        function updateStats() {
            document.getElementById('stat-selections').textContent = state.stats.selections;
            document.getElementById('stat-tools').textContent = state.tools.filter(t => t.active).length;
        }

        function showNotification(msg) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded-full shadow-xl animate-pop z-50';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Save on input change
        document.getElementById('openrouter-key').addEventListener('change', saveSettings);
        document.getElementById('model-select').addEventListener('change', saveSettings);
    </script>
</body>
</html>
