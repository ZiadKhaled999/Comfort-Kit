<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Selection Action Menu - MiMo V2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f94706",
                        "wiki-blue": "#3366cc",
                        "reddit-orange": "#FF4500",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: { 
                        "display": ["Plus Jakarta Sans", "Inter", "sans-serif"],
                        "sans": ["Plus Jakarta Sans", "sans-serif"],
                        "serif": ["Noto Serif", "serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; display: inline-block; vertical-align: middle; }
        .tool-tip { visibility: hidden; opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; transform: translateY(5px); pointer-events: none; }
        .group:hover .tool-tip { visibility: visible; opacity: 1; transform: translateY(0); }
        
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #334155; }
        
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
        .dark .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        #modal-container { height: 100%; display: flex; flex-direction: column; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display min-h-screen flex flex-col items-center p-8 select-text transition-colors duration-300">

    <!-- Demo Content -->
    <div class="max-w-3xl w-full bg-white dark:bg-slate-800 p-10 rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-none mb-8 border border-slate-100 dark:border-slate-700 transition-all">
        <div class="flex items-center gap-3 mb-6">
            <div class="size-12 bg-primary rounded-2xl flex items-center justify-center text-white shadow-lg shadow-primary/30">
                <span class="material-symbols-outlined text-3xl">bolt</span>
            </div>
            <div>
                <h1 class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">Comfort Zone </h1>
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-widest">Selection Research Suite</p>
            </div>
        </div>
        <p class="text-slate-600 dark:text-slate-300 text-lg leading-relaxed mb-6 font-medium">
            Transform your browsing into a research engine. Highlight keywords like <span class="text-primary border-b-2 border-primary/20 hover:border-primary/50 cursor-help transition-all px-1">Quantum Computing</span>, <span class="text-primary border-b-2 border-primary/20 hover:border-primary/50 cursor-help transition-all px-1">Bio-Technology</span>, or <span class="text-primary border-b-2 border-primary/20 hover:border-primary/50 cursor-help transition-all px-1">Machine Learning</span> to trigger the agent.
        </p>
        <div class="flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border border-slate-100 dark:border-slate-800">
            <span class="material-symbols-outlined text-primary">info</span>
            <p class="text-slate-500 dark:text-slate-400 text-sm">Select any text to reveal the context-aware toolbar.</p>
        </div>
    </div>

    <!-- Floating Menu -->
    <div id="selection-popup" class="fixed hidden animate-pop z-[9999]">
        <div id="menu-bar" class="glass rounded-full shadow-2xl flex items-center px-2 py-1.5 text-white">
            <div class="flex items-center px-1 cursor-grab active:cursor-grabbing mr-1">
                <span class="material-symbols-outlined text-slate-400 text-lg">drag_indicator</span>
            </div>
            
            <div id="tool-container" class="flex items-center"></div>

            <div class="flex items-center gap-1 px-1 border-l border-white/10 ml-1 pl-2">
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-white/10 transition-all active:scale-90">
                    <span class="material-symbols-outlined text-[20px] text-slate-300">tune</span>
                </button>
                <button onclick="hidePopup()" class="p-2 rounded-full text-slate-400 hover:text-white hover:bg-red-500/80 transition-all active:scale-90 ml-1">
                    <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
            </div>
        </div>
        <div class="flex justify-center mt-1">
            <div class="w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[8px] border-t-slate-900/90"></div>
        </div>
    </div>

    <!-- Result Modal Overlay -->
    <div id="result-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[10000] hidden flex items-center justify-center p-4">
        <div id="modal-container" class="bg-white dark:bg-[#0f172a] rounded-[2rem] shadow-2xl w-full max-w-[900px] flex flex-col h-[85vh] overflow-hidden animate-pop border border-slate-200 dark:border-slate-800"></div>
    </div>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[10001] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden animate-pop flex flex-col border border-slate-200 dark:border-slate-800">
            <div class="p-8 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                <div class="flex items-center gap-3">
                    <div class="size-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined">settings</span>
                    </div>
                    <div>
                        <h3 class="font-black text-slate-900 dark:text-white text-lg tracking-tight">Configuration</h3>
                        <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">Personalize your agent</p>
                    </div>
                </div>
                <button onclick="toggleSettings()" class="size-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="p-8 overflow-y-auto custom-scrollbar space-y-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">Engine Authentication</label>
                        <input type="password" id="openrouter-key" placeholder="OpenRouter API Key (sk-or-v1-...)" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl px-5 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none text-slate-900 dark:text-white transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">Intelligence Model</label>
                        <select id="model-select" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl px-5 py-3 text-sm outline-none text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/20 transition-all appearance-none cursor-pointer">
                            <option value="xiaomi/mimo-v2-flash:free">MiMo V2 Flash (Optimized)</option>
                            <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Pro</option>
                            <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-black text-slate-400 mb-4 uppercase tracking-widest">Active Toolbox</label>
                    <div id="settings-tools-list" class="grid grid-cols-2 gap-3"></div>
                </div>

                <div class="flex items-center justify-between p-5 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-slate-400">dark_mode</span>
                        <div>
                            <p class="text-sm font-bold dark:text-white">Dark Interface</p>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-tight">OLED Optimized</p>
                        </div>
                    </div>
                    <button onclick="toggleDarkMode()" id="dark-mode-toggle" class="w-12 h-6 bg-slate-200 dark:bg-primary rounded-full relative transition-all duration-300">
                        <div class="absolute top-1 left-1 dark:left-7 w-4 h-4 bg-white rounded-full transition-all shadow-sm"></div>
                    </button>
                </div>

                <button onclick="saveSettings()" class="w-full py-4 bg-primary text-white rounded-2xl font-black shadow-xl shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest text-xs">Synchronize Changes</button>
            </div>
        </div>
    </div>

    <script>
        const popup = document.getElementById('selection-popup');
        const overlay = document.getElementById('result-overlay');
        const modalContainer = document.getElementById('modal-container');
        const settingsOverlay = document.getElementById('settings-overlay');
        const toolContainer = document.getElementById('tool-container');
        const settingsToolsList = document.getElementById('settings-tools-list');

        let selectedText = "";
        
        const REDDIT_LOGO = `
            <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="w-full h-full p-6 text-reddit-orange bg-white dark:bg-slate-900">
                <path fill="currentColor" d="M16.67 10c0-1.11-.9-2.02-2.01-2.02-.55 0-1.05.22-1.41.58-1.07-.76-2.52-1.25-4.14-1.31l.88-4.11 2.87.61c.01.61.5 1.1 1.11 1.1 1.11 0 2.01-.9 2.01-2.01s-.9-2.01-2.01-2.01c-.88 0-1.62.58-1.89 1.38L6.87 1.55c-.17-.04-.34.07-.38.24l-1.02 4.79c-1.66.04-3.15.53-4.24 1.31-.36-.35-.86-.57-1.4-.57-1.11 0-2.01.91-2.01 2.02 0 .73.39 1.36.97 1.71-.03.14-.04.28-.04.42 0 2.58 3.19 4.67 7.12 4.67s7.12-2.09 7.12-4.67c0-.14-.01-.28-.04-.42.59-.35.98-.98.98-1.71zm-10.4 4.54c-.65 0-1.18-.53-1.18-1.18 0-.65.53-1.18 1.18-1.18.65 0 1.18.53 1.18 1.18 0 .65-.53 1.18-1.18 1.18zm5.83-1.18c0 .65-.53 1.18-1.18 1.18-.65 0-1.18-.53-1.18-1.18 0-.65.53-1.18 1.18-1.18.65 0 1.18.53 1.18 1.18zm.13 2.15c-.47.47-1.3.73-2.23.73s-1.76-.26-2.23-.73c-.11-.11-.11-.29 0-.39.1-.1.29-.1.39 0 .34.34 1.05.54 1.84.54.79 0 1.5-.2 1.84-.54.1-.1.29-.1.39 0 .11.11.11.29 0 .39z"></path>
            </svg>`;

        let state = {
            config: { openrouterKey: "", model: "xiaomi/mimo-v2-flash:free", isDark: false },
            tools: [
                { id: 'summarize', label: 'Summarize', icon: 'auto_awesome', active: true, group: 'ai', color: 'text-amber-400' },
                { id: 'explain', label: 'Deep Explain', icon: 'psychology', active: true, group: 'ai', color: 'text-indigo-400' },
                { id: 'wiki', label: 'Wikipedia', icon: 'menu_book', active: true, group: 'search', color: 'text-sky-400' },
                { id: 'copy', label: 'Smart Copy', icon: 'content_copy', active: true, group: 'util', color: 'text-emerald-400' }
            ]
        };

        // Utility: Fix for Clipboard API restrictions in iframe
        function copyToClipboard(text) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                return true;
            } catch (err) {
                console.error('Copy failed:', err);
                return false;
            }
        }

        window.onload = () => {
            const saved = localStorage.getItem('mimo_research_v3');
            if (saved) {
                state = JSON.parse(saved);
                if (state.config.isDark) document.documentElement.classList.add('dark');
            }
            renderMenuBar();
            renderSettingsTools();
            document.getElementById('openrouter-key').value = state.config.openrouterKey || "";
            document.getElementById('model-select').value = state.config.model || "xiaomi/mimo-v2-flash:free";
        };

        function renderMenuBar() {
            let html = '';
            let currentGroup = '';
            state.tools.filter(t => t.active).forEach(tool => {
                if (currentGroup && currentGroup !== tool.group) html += '<div class="w-px h-4 bg-white/10 mx-1"></div>';
                currentGroup = tool.group;
                html += `
                    <div class="relative group">
                        <button onclick="handleAction('${tool.id}')" class="p-2.5 rounded-full hover:bg-white/10 transition-all active:scale-90 flex items-center justify-center">
                            <span class="material-symbols-outlined text-[22px] ${tool.color}">${tool.icon}</span>
                        </button>
                        <div class="tool-tip absolute -top-12 left-1/2 -translate-x-1/2 bg-slate-800/95 backdrop-blur-md text-white text-[10px] font-black px-3 py-1.5 rounded-lg whitespace-nowrap uppercase tracking-widest shadow-xl border border-white/10">
                            ${tool.label}
                        </div>
                    </div>`;
            });
            toolContainer.innerHTML = html;
        }

        function renderSettingsTools() {
            settingsToolsList.innerHTML = state.tools.map(tool => `
                <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 transition-all">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined ${tool.color}">${tool.icon}</span>
                        <span class="text-xs font-black text-slate-700 dark:text-slate-300 uppercase tracking-tight">${tool.label}</span>
                    </div>
                    <button onclick="toggleToolActive('${tool.id}')" class="w-10 h-5 ${tool.active ? 'bg-primary' : 'bg-slate-300 dark:bg-slate-600'} rounded-full relative transition-all">
                        <div class="absolute top-1 ${tool.active ? 'left-6' : 'left-1'} w-3 h-3 bg-white rounded-full transition-all"></div>
                    </button>
                </div>
            `).join('');
        }

        function toggleToolActive(id) {
            const tool = state.tools.find(t => t.id === id);
            if (tool) tool.active = !tool.active;
            renderSettingsTools();
        }

        function toggleDarkMode() {
            state.config.isDark = !state.config.isDark;
            document.documentElement.classList.toggle('dark');
        }

        function saveSettings() {
            state.config.openrouterKey = document.getElementById('openrouter-key').value;
            state.config.model = document.getElementById('model-select').value;
            localStorage.setItem('mimo_research_v3', JSON.stringify(state));
            renderMenuBar();
            toggleSettings();
        }

        document.addEventListener('mouseup', (e) => {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (text.length > 0 && !overlay.contains(e.target) && !popup.contains(e.target) && !settingsOverlay.contains(e.target)) {
                selectedText = text;
                showPopup(e);
            } else if (!popup.contains(e.target) && !settingsOverlay.contains(e.target)) {
                hidePopup();
            }
        });

        function showPopup(e) {
            popup.style.display = 'block';
            let x = e.clientX - (popup.offsetWidth / 2);
            let y = e.clientY - 95;
            popup.style.left = `${Math.max(10, Math.min(x, window.innerWidth - popup.offsetWidth - 10))}px`;
            popup.style.top = `${Math.max(10, y)}px`;
        }

        function hidePopup() { popup.style.display = 'none'; }
        function toggleSettings() { hidePopup(); settingsOverlay.classList.toggle('hidden'); }
        function closeResult() { overlay.classList.add('hidden'); }

        async function handleAction(id) {
            if (id === 'copy') { 
                copyToClipboard(selectedText); 
                hidePopup(); 
                return; 
            }
            hidePopup();
            overlay.classList.remove('hidden');
            
            modalContainer.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center p-20 text-center space-y-8">
                    <div class="relative flex items-center justify-center">
                        <div class="size-24 rounded-full border-[3px] border-slate-100 dark:border-slate-800 animate-pulse"></div>
                        <div class="absolute size-16 bg-primary rounded-full flex items-center justify-center text-white shadow-2xl shadow-primary/40 animate-bounce">
                            <span class="material-symbols-outlined text-3xl">bolt</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-[0.3em] mb-2">Analyzing Context</p>
                        <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">Generating high-fidelity intelligence...</p>
                    </div>
                </div>`;

            if (id === 'wiki') runWikiSearch();
            else runOpenRouter(id);
        }

        async function runWikiSearch() {
            try {
                const searchResp = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(selectedText)}&srlimit=25&format=json&origin=*`);
                const searchData = await searchResp.json();
                const items = searchData.query.search;

                if (!items || items.length === 0) {
                    renderError("No matches found in the knowledge base.");
                    return;
                }

                const titles = items.map(i => i.title).join('|');
                const imgResp = await fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(titles)}&prop=pageimages&pithumbsize=600&format=json&origin=*`);
                const imgData = await imgResp.json();
                const pages = imgData.query.pages;

                const processedItems = items.map(item => {
                    const pageEntry = Object.values(pages).find(p => p.title === item.title);
                    return { ...item, image: pageEntry?.thumbnail?.source || null };
                });

                renderWikiResults(processedItems);
            } catch (err) { renderError("Wikipedia link disrupted."); }
        }

        function renderWikiResults(items) {
            modalContainer.innerHTML = `
                <div class="flex flex-col h-full">
                    <header class="flex items-center justify-between border-b dark:border-slate-800 px-8 py-6 shrink-0 bg-white dark:bg-[#0f172a]/50">
                        <div class="flex items-center gap-4">
                            <div class="size-12 bg-wiki-blue rounded-2xl flex items-center justify-center text-white shadow-lg shadow-wiki-blue/20">
                                <span class="material-symbols-outlined text-[28px]">menu_book</span>
                            </div>
                            <div>
                                <h2 class="text-slate-900 dark:text-white text-xl font-black tracking-tight">Intelligence Feed</h2>
                                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Wikipedia knowledge engine â€¢ ${items.length} High-priority Results</p>
                            </div>
                        </div>
                        <button onclick="closeResult()" class="size-12 flex items-center justify-center rounded-2xl bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-red-50 dark:hover:bg-red-500/10 hover:text-red-500 transition-all active:scale-90">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </header>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-8 space-y-6 bg-slate-50/30 dark:bg-transparent">
                        ${items.map((item, idx) => `
                            <div class="group flex flex-col md:flex-row items-stretch gap-6 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 hover:border-wiki-blue/30 hover:shadow-2xl hover:shadow-slate-200/50 dark:hover:shadow-none transition-all duration-300 bg-white dark:bg-[#1e293b]/40">
                                <div class="w-full md:w-48 shrink-0 h-44 md:h-auto bg-slate-100 dark:bg-slate-800 rounded-2xl overflow-hidden border dark:border-slate-700 relative">
                                    ${item.image ? 
                                        `<img src="${item.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" />` : 
                                        `<div class="w-full h-full flex items-center justify-center">${REDDIT_LOGO}</div>`
                                    }
                                </div>
                                <div class="flex flex-1 flex-col justify-between py-1">
                                    <div>
                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="bg-wiki-blue/10 text-wiki-blue text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded-full">Record #${idx + 1}</span>
                                            ${!item.image ? `<span class="bg-reddit-orange/10 text-reddit-orange text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded-full">Community Optimized</span>` : ''}
                                        </div>
                                        <h3 class="text-slate-900 dark:text-white text-2xl font-black leading-tight mb-3 group-hover:text-wiki-blue transition-colors">${item.title}</h3>
                                        <p class="text-slate-600 dark:text-slate-400 text-sm leading-relaxed line-clamp-3 font-medium">
                                            ${item.snippet.replace(/<span class="searchmatch">/g, '<span class="text-wiki-blue font-black underline decoration-wiki-blue/20">').replace(/<\/span>/g, '</span>')}...
                                        </p>
                                    </div>
                                    <div class="flex items-center justify-between mt-6">
                                        <div class="flex items-center gap-4 text-slate-400">
                                            <div class="flex items-center gap-1.5">
                                                <span class="material-symbols-outlined text-sm">history_edu</span>
                                                <span class="text-[10px] font-black uppercase tracking-widest">Verified Entry</span>
                                            </div>
                                        </div>
                                        <button onclick="openInAppReader('${item.title.replace(/'/g, "\\'")}')" class="flex items-center gap-2 px-6 py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl text-xs font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-lg">
                                            <span>Full Analysis</span>
                                            <span class="material-symbols-outlined text-sm">arrow_forward</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        async function openInAppReader(title) {
            modalContainer.innerHTML = `
                <div class="flex-1 flex flex-col p-8 space-y-6">
                    <div class="h-20 skeleton rounded-2xl w-full"></div>
                    <div class="h-8 skeleton rounded-xl w-1/2"></div>
                    <div class="space-y-3">
                        <div class="h-4 skeleton rounded w-full"></div>
                        <div class="h-4 skeleton rounded w-full"></div>
                        <div class="h-4 skeleton rounded w-3/4"></div>
                    </div>
                </div>`;
            
            try {
                const resp = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(title)}&format=json&origin=*`);
                const data = await resp.json();
                const page = Object.values(data.query.pages)[0];
                
                modalContainer.innerHTML = `
                    <div class="flex flex-col h-full bg-white dark:bg-[#0f172a]">
                        <header class="flex items-center justify-between border-b dark:border-slate-800 px-8 py-6 shrink-0">
                            <div class="flex items-center gap-4">
                                <button onclick="runWikiSearch()" class="size-12 flex items-center justify-center rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all active:scale-90">
                                    <span class="material-symbols-outlined">west</span>
                                </button>
                                <div>
                                    <h2 class="text-slate-900 dark:text-white text-xl font-black tracking-tight">${title}</h2>
                                    <p class="text-wiki-blue text-[10px] font-black uppercase tracking-widest">Full Record Access</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="window.open('https://en.wikipedia.org/wiki/${encodeURIComponent(title)}')" class="hidden md:flex items-center gap-2 px-5 py-2.5 text-[10px] font-black uppercase tracking-widest border-2 dark:border-slate-700 rounded-2xl hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-white transition-all">
                                    <span class="material-symbols-outlined text-sm">open_in_new</span> External
                                </button>
                                <button onclick="closeResult()" class="text-slate-400"><span class="material-symbols-outlined">close</span></button>
                            </div>
                        </header>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-10 md:px-24">
                            <div class="max-w-3xl mx-auto">
                                <div class="w-full h-56 bg-slate-50 dark:bg-slate-800/50 rounded-[2.5rem] mb-12 flex items-center justify-center text-slate-200 dark:text-slate-700 border-2 border-dashed border-slate-100 dark:border-slate-800 overflow-hidden">
                                    ${REDDIT_LOGO}
                                </div>
                                <h1 class="text-5xl font-black text-slate-900 dark:text-white mb-8 leading-tight tracking-tight">${title}</h1>
                                <div class="text-slate-700 dark:text-slate-300 text-xl leading-[2] space-y-8 font-medium">
                                    ${page.extract ? page.extract.split('\n').filter(p => p.trim()).map(p => `<p>${p}</p>`).join('') : '<p class="italic text-slate-500">Telemetry empty for this node.</p>'}
                                </div>
                            </div>
                        </div>
                        <footer class="p-8 border-t dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 shrink-0 flex justify-center">
                             <button onclick="handleReferenceCapture('${title.replace(/'/g, "\\'")}')" class="px-10 py-4 bg-primary text-white rounded-2xl font-black shadow-2xl shadow-primary/30 hover:scale-105 transition-all flex items-center gap-3 uppercase tracking-widest text-xs">
                                <span class="material-symbols-outlined text-xl">content_copy</span> Capture Reference
                             </button>
                        </footer>
                    </div>`;
            } catch (err) { renderError("Article decryption failed."); }
        }

        function handleReferenceCapture(title) {
            const success = copyToClipboard(`Reference: ${title} via MiMo Agent`);
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            if (success) {
                btn.innerHTML = '<span class="material-symbols-outlined text-xl">check</span> Captured';
                btn.classList.replace('bg-primary', 'bg-emerald-500');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-emerald-500', 'bg-primary');
                }, 2000);
            }
        }

        async function runOpenRouter(mode) {
            if (!state.config.openrouterKey) { renderError("API Auth Missing."); return; }
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${state.config.openrouterKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: state.config.model,
                        messages: [{ role: "user", content: `${mode}: ${selectedText}` }]
                    })
                });
                const data = await response.json();
                renderAIResult(mode, data.choices[0].message.content);
            } catch (err) { renderError("Intelligence bridge timeout."); }
        }

        function renderAIResult(mode, text) {
            modalContainer.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-slate-900">
                    <header class="flex items-center justify-between border-b dark:border-slate-800 px-8 py-6">
                         <div class="flex items-center gap-3">
                            <div class="size-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined capitalize">auto_awesome</span>
                            </div>
                            <h3 class="font-black text-xl dark:text-white capitalize tracking-tight">${mode} Synthesis</h3>
                         </div>
                         <button onclick="closeResult()" class="text-slate-400"><span class="material-symbols-outlined">close</span></button>
                    </header>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-10 text-xl leading-[1.8] dark:text-slate-300 whitespace-pre-wrap font-medium">${text}</div>
                </div>`;
        }

        function renderError(msg) {
            modalContainer.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center p-20 text-center">
                    <div class="size-20 bg-red-500/10 rounded-3xl flex items-center justify-center text-red-500 mb-6">
                        <span class="material-symbols-outlined text-4xl">warning</span>
                    </div>
                    <h3 class="text-xl font-black text-slate-900 dark:text-white mb-2 uppercase tracking-tight">System Fault</h3>
                    <p class="text-slate-500 font-bold mb-8">${msg}</p>
                    <button onclick="closeResult()" class="px-8 py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-black uppercase tracking-widest text-xs">Acknowledge</button>
                </div>`;
        }
    </script>
</body>
</html>
